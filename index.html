<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>Cyber-Nexus V3.0 Ultra</title>
  <meta id="meta-desc" name="description" content="Cyber-Nexus Ultra: Next-gen data visualization" />
  <meta property="og:title" content="Cyber-Nexus V3.0 Ultra" />
  <meta id="og-desc" property="og:description" content="Cyber-Nexus Ultra: Next-gen data visualization" />
  <meta property="og:type" content="website" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Electrolize&family=Share+Tech+Mono&family=Michroma&family=Cairo:wght@400;700;900&family=Tajawal:wght@400;700;900&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #00ffcc;
      --secondary-color: #007766;
      --bg-color: #0a0a0a;
      --panel-bg: rgba(10, 10, 10, 0.92);
      --panel-border: rgba(0, 255, 204, 0.4);
      --text-color: #e0ffff;
      --error-color: #ff3366;
      --font-main: 'Electrolize', sans-serif;
      --font-mono: 'Share Tech Mono', monospace;
      --ui-z: 9999;
      --scanline-opacity: 0.12;
      --vignette-opacity: 0.7;
      --grain-opacity: 0.04;
      --crt-curve: 0;
      --glow-intensity: 20;
      --animation-speed: 1;
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      background: var(--bg-color);
      overflow: hidden;
      font-family: var(--font-main);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      touch-action: manipulation;
      color: var(--text-color);
      user-select: none;
    }

    canvas#c {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    /* UI Layer with Glassmorphism */
    #ui-layer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: var(--ui-z);
      transform: translateY(-120%);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      background: var(--panel-bg);
      border-bottom: 2px solid var(--panel-border);
      padding: 20px;
      backdrop-filter: blur(30px) saturate(200%);
      -webkit-backdrop-filter: blur(30px) saturate(200%);
      box-shadow: 
        0 8px 50px rgba(0, 255, 204, 0.2),
        0 0 100px rgba(0, 255, 204, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      max-height: 95vh;
      overflow-y: auto;
      border-radius: 0 0 25px 25px;
    }

    body.admin-mode #ui-layer {
      transform: translateY(0);
    }

    /* Close Button for UI */
    #ui-close-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 51, 102, 0.2);
      border: 2px solid var(--error-color);
      color: var(--error-color);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      z-index: 10000;
    }
    #ui-close-btn:hover {
      background: var(--error-color);
      color: white;
      transform: rotate(90deg);
      box-shadow: 0 0 20px var(--error-color);
    }

    /* Click outside to close overlay */
    #ui-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: calc(var(--ui-z) - 1);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    body.admin-mode #ui-overlay {
      opacity: 1;
      visibility: visible;
    }

    #ui-row {
      display: flex;
      gap: 15px;
      align-items: flex-start;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    textarea#msg-input {
      flex: 1 1 500px;
      min-width: 200px;
      height: 140px;
      resize: vertical;
      background: rgba(0, 0, 0, 0.8);
      color: var(--text-color);
      border: 2px solid var(--secondary-color);
      padding: 15px;
      font-size: 15px;
      border-radius: 12px;
      direction: ltr;
      text-align: left;
      box-shadow: 
        inset 0 0 15px rgba(0, 255, 204, 0.15),
        0 0 20px rgba(0, 255, 204, 0.1);
      transition: all 0.3s;
      font-family: var(--font-mono);
    }
    textarea#msg-input:focus {
      border-color: var(--primary-color);
      box-shadow: 
        inset 0 0 20px rgba(0, 255, 204, 0.3),
        0 0 30px rgba(0, 255, 204, 0.3);
      outline: none;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 150px;
    }

    /* Advanced Buttons */
    button, select, input[type="file"] {
      background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(0,40,40,0.8));
      color: var(--primary-color);
      border: 2px solid var(--secondary-color);
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      min-height: 48px;
      font-family: var(--font-main);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 4px 15px rgba(0, 255, 204, 0.15),
        inset 0 1px 0 rgba(255,255,255,0.1);
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: radial-gradient(circle, rgba(0,255,204,0.3) 0%, transparent 70%);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
      border-radius: 50%;
    }
    button:hover::before {
      width: 300px;
      height: 300px;
    }
    
    button:hover, select:hover {
      border-color: var(--primary-color);
      box-shadow: 
        0 8px 30px rgba(0, 255, 204, 0.4),
        0 0 50px rgba(0, 255, 204, 0.2);
      transform: translateY(-3px);
    }
    button:active {
      transform: translateY(-1px);
    }
    
    button.primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: #000;
      border-color: var(--primary-color);
      box-shadow: 
        0 0 30px rgba(0, 255, 204, 0.5),
        0 8px 30px rgba(0, 255, 204, 0.3);
    }
    button.primary:hover {
      box-shadow: 
        0 0 50px rgba(0, 255, 204, 0.7),
        0 0 80px rgba(0, 255, 204, 0.4);
    }
    
    button.success {
      background: linear-gradient(135deg, #00ff88, #007744);
      color: #000;
      border-color: #00ff88;
    }
    button.danger {
      background: linear-gradient(135deg, #ff3366, #990033);
      color: #fff;
      border-color: #ff3366;
    }
    button.accent {
      background: linear-gradient(135deg, #ff00ff, #770077);
      color: #fff;
      border-color: #ff00ff;
    }

    input[type="file"] {
      color: var(--text-color);
      padding: 10px 15px;
      display: flex;
      align-items: center;
    }
    input[type="file"]::-webkit-file-upload-button {
      visibility: hidden;
      width: 0;
    }
    input[type="file"]::before {
      content: 'ğŸ“ Ø±ÙØ¹ ØµÙˆØ±Ø©';
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    /* Secret Trigger - Fixed Position */
    #secret-trigger {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      z-index: 10000;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: 3px solid var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 
        0 0 30px rgba(0, 255, 204, 0.5),
        0 8px 30px rgba(0, 0, 0, 0.5);
      transition: all 0.3s;
      animation: pulse-glow 2s infinite;
    }
    #secret-trigger::before {
      content: 'âš™ï¸';
    }
    #secret-trigger:hover {
      transform: scale(1.1) rotate(30deg);
      box-shadow: 
        0 0 50px rgba(0, 255, 204, 0.8),
        0 0 80px rgba(0, 255, 204, 0.4);
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 30px rgba(0, 255, 204, 0.5); }
      50% { box-shadow: 0 0 50px rgba(0, 255, 204, 0.8), 0 0 70px rgba(0, 255, 204, 0.4); }
    }

    /* Floating Action Buttons */
    .fab-container {
      position: fixed;
      bottom: 100px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 9998;
      transition: all 0.3s;
    }
    body.admin-mode .fab-container {
      opacity: 0;
      pointer-events: none;
    }
    .fab {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      padding: 0;
      animation: none;
    }

    #readable-content {
      position: absolute;
      left: -9999px;
      opacity: 0;
    }

    /* Enhanced Error Overlay */
    #error-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(20px);
      text-align: center;
    }
    #error-overlay.show {
      display: flex;
      animation: glitch-in 0.5s;
    }
    @keyframes glitch-in {
      0% { transform: translateX(-10px); opacity: 0; }
      20% { transform: translateX(10px); }
      40% { transform: translateX(-10px); }
      60% { transform: translateX(10px); }
      100% { transform: translateX(0); opacity: 1; }
    }
    #error-overlay-content {
      padding: 40px;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(20, 0, 0, 0.95), rgba(40, 0, 0, 0.9));
      border: 3px solid var(--error-color);
      box-shadow: 
        0 0 60px rgba(255, 51, 102, 0.6),
        inset 0 0 60px rgba(255, 51, 102, 0.1);
      max-width: 90%;
      position: relative;
      overflow: hidden;
    }
    #error-overlay-content::before {
      content: '';
      position: absolute;
      inset: -50%;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(255, 51, 102, 0.1) 2px,
        rgba(255, 51, 102, 0.1) 4px
      );
      animation: scan 8s linear infinite;
      pointer-events: none;
    }
    @keyframes scan {
      0% { transform: translateY(0); }
      100% { transform: translateY(50%); }
    }

    /* Loading Indicator */
    #loading-indicator {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10002;
      display: flex;
      gap: 12px;
      align-items: center;
      background: rgba(0, 0, 0, 0.8);
      padding: 12px 20px;
      border-radius: 15px;
      border: 2px solid var(--secondary-color);
      box-shadow: 0 0 30px rgba(0, 255, 204, 0.3);
    }
    .loader-ring {
      width: 30px;
      height: 30px;
      border: 3px solid transparent;
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #countdown-timer, #battery-status, #fps-counter, #image-status {
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--primary-color);
      text-shadow: 0 0 10px var(--primary-color);
    }

    /* Effects Layer */
    #effects-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
    }
    .scanlines {
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, var(--scanline-opacity)),
        rgba(0, 0, 0, var(--scanline-opacity)) 1px,
        transparent 1px,
        transparent 3px
      );
      pointer-events: none;
    }
    .vignette {
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at center, transparent 30%, rgba(0, 0, 0, var(--vignette-opacity)) 100%);
      pointer-events: none;
    }
    .grain {
      position: absolute;
      inset: 0;
      opacity: var(--grain-opacity);
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }

    /* Drop Zone */
    #drop-zone {
      position: fixed;
      inset: 0;
      background: rgba(0, 255, 204, 0.15);
      border: 5px dashed var(--primary-color);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10003;
      backdrop-filter: blur(10px);
      flex-direction: column;
      gap: 20px;
    }
    #drop-zone.active {
      display: flex;
      animation: pulse-border 1s infinite;
    }
    @keyframes pulse-border {
      0%, 100% { border-color: var(--primary-color); }
      50% { border-color: rgba(0, 255, 204, 0.5); }
    }
    #drop-zone-icon {
      font-size: 80px;
      animation: bounce 1s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    #drop-zone-text {
      font-size: 28px;
      color: var(--primary-color);
      text-shadow: 0 0 30px var(--primary-color);
      font-weight: 700;
    }

    /* Responsive */
    @media (max-width: 768px) {
      #ui-layer { padding: 15px; max-height: 90vh; }
      textarea#msg-input { height: 100px; flex-basis: 100%; font-size: 13px; }
      .controls { flex-direction: row; flex-wrap: wrap; }
      .controls button { flex: 1; min-width: 120px; }
      #secret-trigger { width: 50px; height: 50px; font-size: 20px; bottom: 15px; right: 15px; }
      .fab-container { bottom: 80px; right: 15px; }
      .fab { width: 45px; height: 45px; font-size: 18px; }
    }

    /* Utility Classes */
    .flex-row-wrap {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .label-group {
      display: flex;
      gap: 10px;
      align-items: center;
      background: rgba(0, 0, 0, 0.4);
      padding: 8px 15px;
      border-radius: 10px;
      border: 1px solid var(--secondary-color);
    }
    .label-group span {
      font-weight: 700;
      color: var(--text-color);
      white-space: nowrap;
    }

    /* Collapsible Sections */
    .collapsible {
      border: 2px solid var(--secondary-color);
      border-radius: 12px;
      margin-top: 15px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.3);
    }
    .collapsible-header {
      background: linear-gradient(90deg, rgba(0,255,204,0.1), transparent);
      padding: 15px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      transition: all 0.3s;
    }
    .collapsible-header:hover {
      background: linear-gradient(90deg, rgba(0,255,204,0.2), transparent);
    }
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .collapsible.open .collapsible-content {
      max-height: 600px;
      padding: 20px;
    }
    .collapsible-icon {
      transition: transform 0.3s;
      font-size: 12px;
    }
    .collapsible.open .collapsible-icon {
      transform: rotate(180deg);
    }

    /* Sliders */
    input[type="range"] {
      -webkit-appearance: none;
      width: 120px;
      height: 8px;
      background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
      border-radius: 4px;
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 15px var(--primary-color);
      transition: transform 0.2s;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      background: var(--secondary-color);
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle-switch.active {
      background: var(--primary-color);
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .toggle-switch.active::after {
      transform: translateX(24px);
    }

    /* Toast Notification */
    #toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: #000;
      padding: 15px 30px;
      border-radius: 50px;
      font-weight: 700;
      z-index: 10005;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 10px 40px rgba(0, 255, 204, 0.4);
    }
    #toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .sr-only { position: absolute; left: -9999px; }
  </style>
</head>
<body>

  <!-- UI Overlay for closing -->
  <div id="ui-overlay"></div>

  <!-- UI Layer -->
  <div id="ui-layer" aria-hidden="true">
    <button id="ui-close-btn" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    
    <div id="ui-row">
      <textarea id="msg-input" placeholder="Ø£Ø¯Ø®Ù„ Ù†ØµÙƒ Ù‡Ù†Ø§... Ø³ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡ Ø¨ØªØ£Ø«ÙŠØ±Ø§Øª Ø³Ø§ÙŠØ¨Ø±ÙŠØ© Ø®Ø±Ø§ÙÙŠØ©!" aria-label="Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¯Ø®Ù„"></textarea>
      <div class="controls">
        <button id="btn-update" class="primary">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        <button id="btn-export-png" class="success">ğŸ’¾ Ø­ÙØ¸ PNG</button>
        <button id="btn-share">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©</button>
        <button id="btn-fullscreen">â›¶ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</button>
      </div>
    </div>

    <div class="flex-row-wrap">
      <label class="label-group">
        <span>ğŸ¨ Ø§Ù„Ø®Ù„ÙÙŠØ©:</span>
        <select id="bg-select">
          <option value="cyberweb">Ø´Ø¨ÙƒØ© Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠØ©</option>
          <option value="particles">Ø¬Ø³ÙŠÙ…Ø§Øª 3D</option>
          <option value="matrix">Ù…Ø·Ø±Ù‚Ø© Ù…Ø§ØªØ±ÙŠÙƒØ³</option>
          <option value="aurora">Ø´ÙÙ‚ Ù‚Ø·Ø¨ÙŠ</option>
          <option value="fireflies">ÙŠØ±Ø§Ø¹Ø§Øª</option>
          <option value="gradient">ØªØ¯Ø±Ø¬ Ù…ØªØ­Ø±Ùƒ</option>
          <option value="void">ÙØ±Ø§Øº</option>
          <option value="image">ØµÙˆØ±Ø© Ù…Ø®ØµØµØ©</option>
        </select>
      </label>

      <label class="label-group">
        <span>ğŸŒˆ Ø§Ù„Ø³Ù…Ø©:</span>
        <select id="theme-select">
          <option value="cyan">Ø³Ù…Ø§ÙˆÙŠ Ù†ÙŠÙˆÙ†</option>
          <option value="green">Ø£Ø®Ø¶Ø± Ù†ÙŠÙˆÙ†</option>
          <option value="purple">Ø¨Ù†ÙØ³Ø¬ÙŠ Ù†ÙŠÙˆÙ†</option>
          <option value="red">Ø£Ø­Ù…Ø± Ù†ÙŠÙˆÙ†</option>
          <option value="gold">Ø°Ù‡Ø¨ÙŠ Ù†ÙŠÙˆÙ†</option>
          <option value="pink">ÙˆØ±Ø¯ÙŠ Ù†ÙŠÙˆÙ†</option>
          <option value="blue">Ø£Ø²Ø±Ù‚ Ù†ÙŠÙˆÙ†</option>
          <option value="orange">Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù†ÙŠÙˆÙ†</option>
        </select>
      </label>

      <label class="label-group">
        <span>âœï¸ Ø§Ù„Ø®Ø·:</span>
        <select id="font-select">
          <option value="electrolize">Electrolize</option>
          <option value="orbitron">Orbitron</option>
          <option value="rajdhani">Rajdhani</option>
          <option value="sharetechmono">Share Tech Mono</option>
          <option value="michroma">Michroma</option>
          <option value="cairo">Cairo (Ø¹Ø±Ø¨ÙŠ)</option>
          <option value="tajawal">Tajawal (Ø¹Ø±Ø¨ÙŠ)</option>
        </select>
      </label>

      <label class="label-group">
        <span>ğŸ“ Ø±ÙØ¹:</span>
        <input id="img-uploader" type="file" accept="image/*"/>
      </label>

      <button id="btn-clear-image">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø©</button>
      <button id="btn-clear-all" class="danger">â™»ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
    </div>

    <!-- Effects Section -->
    <div class="collapsible open" id="effects-section">
      <div class="collapsible-header">
        <span>âœ¨ Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</span>
        <span class="collapsible-icon">â–¼</span>
      </div>
      <div class="collapsible-content">
        <div class="flex-row-wrap">
          <label class="label-group">
            <span>Scanlines:</span>
            <input type="range" id="scanline-slider" min="0" max="100" value="12">
          </label>
          <label class="label-group">
            <span>Vignette:</span>
            <input type="range" id="vignette-slider" min="0" max="100" value="70">
          </label>
          <label class="label-group">
            <span>Grain:</span>
            <input type="range" id="grain-slider" min="0" max="100" value="4">
          </label>
          <label class="label-group">
            <span>Glow:</span>
            <input type="range" id="glow-slider" min="0" max="100" value="50">
          </label>
          <label class="label-group">
            <span>Glitch:</span>
            <div class="toggle-switch active" id="glitch-toggle"></div>
          </label>
          <label class="label-group">
            <span>Animation:</span>
            <div class="toggle-switch active" id="animation-toggle"></div>
          </label>
        </div>
      </div>
    </div>

    <!-- Image Filters Section -->
    <div class="collapsible" id="filters-section">
      <div class="collapsible-header">
        <span>ğŸ–¼ï¸ ÙÙ„Ø§ØªØ± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</span>
        <span class="collapsible-icon">â–¼</span>
      </div>
      <div class="collapsible-content">
        <div class="flex-row-wrap">
          <label class="label-group">
            <span>Ø³Ø·ÙˆØ¹:</span>
            <input type="range" id="brightness-slider" min="0" max="200" value="100">
          </label>
          <label class="label-group">
            <span>ØªØ¨Ø§ÙŠÙ†:</span>
            <input type="range" id="contrast-slider" min="0" max="200" value="120">
          </label>
          <label class="label-group">
            <span>ØªØ´Ø¨Ø¹:</span>
            <input type="range" id="saturation-slider" min="0" max="200" value="100">
          </label>
          <label class="label-group">
            <span>Ø¶Ø¨Ø§Ø¨ÙŠØ©:</span>
            <input type="range" id="blur-slider" min="0" max="20" value="0">
          </label>
          <label class="label-group">
            <span>Ø´ÙØ§ÙÙŠØ©:</span>
            <input type="range" id="opacity-slider" min="0" max="100" value="100">
          </label>
          <label class="label-group">
            <span>ØªØ¯Ø±Ø¬:</span>
            <input type="range" id="hue-slider" min="0" max="360" value="0">
          </label>
          <button id="btn-reset-filters">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>
      </div>
    </div>

    <!-- Text Effects Section -->
    <div class="collapsible" id="text-section">
      <div class="collapsible-header">
        <span>ğŸ“ ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</span>
        <span class="collapsible-icon">â–¼</span>
      </div>
      <div class="collapsible-content">
        <div class="flex-row-wrap">
          <label class="label-group">
            <span>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</span>
            <input type="range" id="font-size-slider" min="20" max="200" value="80">
          </label>
          <label class="label-group">
            <span>ØªØ¨Ø§Ø¹Ø¯:</span>
            <input type="range" id="letter-spacing-slider" min="-5" max="20" value="0">
          </label>
          <label class="label-group">
            <span>Ø¯ÙˆØ±Ø§Ù†:</span>
            <input type="range" id="rotation-slider" min="0" max="360" value="0">
          </label>
          <label class="label-group">
            <span>Ø¸Ù„:</span>
            <div class="toggle-switch active" id="shadow-toggle"></div>
          </label>
          <label class="label-group">
            <span>Ø¥Ø¶Ø§Ø¡Ø©:</span>
            <div class="toggle-switch" id="lighting-toggle"></div>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Canvas -->
  <canvas id="c" aria-label="Cyber-Nexus Display"></canvas>

  <!-- Effects Overlay -->
  <div id="effects-layer">
    <div class="scanlines"></div>
    <div class="vignette"></div>
    <div class="grain"></div>
  </div>

  <!-- Drop Zone -->
  <div id="drop-zone">
    <div id="drop-zone-icon">ğŸ“¸</div>
    <div id="drop-zone-text">Ø£Ø³Ù‚Ø· Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§</div>
  </div>

  <!-- Floating Action Buttons -->
  <div class="fab-container">
    <button class="fab primary" id="fab-export" title="Ø­ÙØ¸ ØµÙˆØ±Ø©">ğŸ’¾</button>
    <button class="fab accent" id="fab-share" title="Ù…Ø´Ø§Ø±ÙƒØ©">ğŸ“¤</button>
    <button class="fab" id="fab-fullscreen" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©">â›¶</button>
  </div>

  <!-- Secret Trigger -->
  <div id="secret-trigger" role="button" aria-label="ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" title="ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"></div>

  <!-- Error Overlay -->
  <div id="error-overlay" aria-hidden="true">
    <div id="error-overlay-content">
      <h2 style="font-size: 42px; color: var(--error-color); margin-bottom: 20px; text-shadow: 0 0 30px var(--error-color);">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</h2>
      <p id="error-message" style="font-size: 18px; color: #ffcccc; margin-bottom: 30px;"></p>
      <button id="btn-retry-fetch" class="primary" style="padding: 15px 40px; font-size: 16px;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loading-indicator" aria-hidden="true">
    <div class="loader-ring"></div>
    <span id="countdown-timer"></span>
    <span id="battery-status"></span>
    <span id="fps-counter"></span>
    <span id="image-status"></span>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <div class="sr-only" role="status" id="aria-status">Ø¬Ø§Ù‡Ø²</div>

<script>
/* ==================== CYBER-NEXUS V3.0 ULTRA ==================== */

const CONSTANTS = {
  RAW_URL: "https://gist.githubusercontent.com/tombad8900/02c19d224a9d2cafc91bf918c81e27a6/raw/",
  FETCH_INTERVAL: 10 * 60 * 1000,
  FETCH_TIMEOUT: 15 * 1000,
  DPR_MAX: 2,
  DB_NAME: 'CyberNexusDB',
  DB_VERSION: 1,
  STORE_NAME: 'images'
};

const THEMES = {
  cyan: { primary: '#00ffcc', secondary: '#007766', border: 'rgba(0, 255, 204, 0.4)' },
  green: { primary: '#00ff41', secondary: '#007700', border: 'rgba(0, 255, 65, 0.4)' },
  purple: { primary: '#bf00ff', secondary: '#660099', border: 'rgba(191, 0, 255, 0.4)' },
  red: { primary: '#ff0040', secondary: '#990020', border: 'rgba(255, 0, 64, 0.4)' },
  gold: { primary: '#ffd700', secondary: '#b8860b', border: 'rgba(255, 215, 0, 0.4)' },
  pink: { primary: '#ff1493', secondary: '#c71585', border: 'rgba(255, 20, 147, 0.4)' },
  blue: { primary: '#00bfff', secondary: '#006699', border: 'rgba(0, 191, 255, 0.4)' },
  orange: { primary: '#ff6600', secondary: '#cc5200', border: 'rgba(255, 102, 0, 0.4)' }
};

const FONTS = {
  electrolize: "'Electrolize', sans-serif",
  orbitron: "'Orbitron', sans-serif",
  rajdhani: "'Rajdhani', sans-serif",
  sharetechmono: "'Share Tech Mono', monospace",
  michroma: "'Michroma', sans-serif",
  cairo: "'Cairo', sans-serif",
  tajawal: "'Tajawal', sans-serif"
};

// State
const state = {
  canvas: null, ctx: null,
  w: 0, h: 0, dpr: 1,
  bgMode: 'cyberweb',
  theme: 'cyan',
  font: 'electrolize',
  lines: [], displayedText: [],
  uploadedImage: null,
  imageLoaded: false,
  glitchIntensity: 0,
  mouse: { x: 0, y: 0, active: false },
  particles: [], matrixDrops: [], fireflies: [],
  animationId: null,
  lastFrameTime: 0,
  fps: 60,
  effects: {
    scanlines: 12, vignette: 70, grain: 4,
    glow: 50, glitch: true, animation: true
  },
  filters: {
    brightness: 100, contrast: 120, saturation: 100,
    blur: 0, opacity: 100, hue: 0
  },
  textStyle: {
    size: 80, letterSpacing: 0, rotation: 0,
    shadow: true, lighting: false
  },
  db: null,
  isAdmin: false
};

// DOM Elements
const elements = {};

/* ==================== IndexedDB for Images ==================== */
function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(CONSTANTS.DB_NAME, CONSTANTS.DB_VERSION);
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      state.db = request.result;
      resolve(state.db);
    };
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(CONSTANTS.STORE_NAME)) {
        db.createObjectStore(CONSTANTS.STORE_NAME, { keyPath: 'id' });
      }
    };
  });
}

async function saveImageToDB(imageData, metadata = {}) {
  if (!state.db) await initDB();
  return new Promise((resolve, reject) => {
    const transaction = state.db.transaction([CONSTANTS.STORE_NAME], 'readwrite');
    const store = transaction.objectStore(CONSTANTS.STORE_NAME);
    const data = {
      id: 'uploaded-image',
      data: imageData,
      timestamp: Date.now(),
      ...metadata
    };
    const request = store.put(data);
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

async function loadImageFromDB() {
  if (!state.db) await initDB();
  return new Promise((resolve, reject) => {
    const transaction = state.db.transaction([CONSTANTS.STORE_NAME], 'readonly');
    const store = transaction.objectStore(CONSTANTS.STORE_NAME);
    const request = store.get('uploaded-image');
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

async function clearImageFromDB() {
  if (!state.db) await initDB();
  return new Promise((resolve, reject) => {
    const transaction = state.db.transaction([CONSTANTS.STORE_NAME], 'readwrite');
    const store = transaction.objectStore(CONSTANTS.STORE_NAME);
    const request = store.delete('uploaded-image');
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

/* ==================== Utility Functions ==================== */
function $(id) { return document.getElementById(id); }
function showToast(message, duration = 3000) {
  const toast = $('toast');
  toast.textContent = message;
  toast.classList.add('show');
  if (navigator.vibrate) navigator.vibrate(50);
  setTimeout(() => toast.classList.remove('show'), duration);
}
function now() { return performance.now(); }

/* ==================== Initialization ==================== */
function init() {
  state.canvas = $('c');
  state.ctx = state.canvas.getContext('2d', { alpha: false, desynchronized: true });
  
  cacheElements();
  setupEventListeners();
  resizeCanvas();
  initDB().then(() => {
    loadSavedImage();
  }).catch(console.error);
  
  initParticles();
  initMatrixDrops();
  initFireflies();
  
  restorePreferences();
  updateEffectsCSS();
  
  requestAnimationFrame(renderLoop);
  showToast('Cyber-Nexus V3.0 Ø¬Ø§Ù‡Ø²! âš¡', 2000);
}

function cacheElements() {
  const ids = [
    'ui-layer', 'ui-overlay', 'ui-close-btn', 'msg-input',
    'btn-update', 'btn-export-png', 'btn-share', 'btn-fullscreen',
    'bg-select', 'theme-select', 'font-select', 'img-uploader',
    'btn-clear-image', 'btn-clear-all', 'secret-trigger',
    'btn-retry-fetch', 'error-overlay', 'error-message',
    'loading-indicator', 'countdown-timer', 'battery-status',
    'fps-counter', 'image-status', 'drop-zone', 'toast',
    'scanline-slider', 'vignette-slider', 'grain-slider',
    'glow-slider', 'glitch-toggle', 'animation-toggle',
    'brightness-slider', 'contrast-slider', 'saturation-slider',
    'blur-slider', 'opacity-slider', 'hue-slider', 'btn-reset-filters',
    'font-size-slider', 'letter-spacing-slider', 'rotation-slider',
    'shadow-toggle', 'lighting-toggle',
    'fab-export', 'fab-share', 'fab-fullscreen'
  ];
  ids.forEach(id => elements[id] = $(id));
}

/* ==================== Canvas & Resize ==================== */
function resizeCanvas() {
  state.dpr = Math.min(window.devicePixelRatio || 1, CONSTANTS.DPR_MAX);
  state.w = window.innerWidth;
  state.h = window.innerHeight;
  
  state.canvas.style.width = state.w + 'px';
  state.canvas.style.height = state.h + 'px';
  state.canvas.width = Math.floor(state.w * state.dpr);
  state.canvas.height = Math.floor(state.h * state.dpr);
  
  state.ctx.setTransform(state.dpr, 0, 0, state.dpr, 0, 0);
  state.ctx.imageSmoothingEnabled = true;
  state.ctx.imageSmoothingQuality = 'high';
}

/* ==================== Background Systems ==================== */
function initParticles() {
  state.particles = [];
  const count = state.w < 768 ? 40 : 80;
  for (let i = 0; i < count; i++) {
    state.particles.push({
      x: Math.random() * state.w,
      y: Math.random() * state.h,
      z: Math.random() * 2 + 0.5,
      vx: (Math.random() - 0.5) * 0.8,
      vy: (Math.random() - 0.5) * 0.8,
      life: Math.random(),
      pulse: Math.random() * Math.PI * 2
    });
  }
}

function initMatrixDrops() {
  state.matrixDrops = [];
  const cols = Math.floor(state.w / 20);
  for (let i = 0; i < cols; i++) {
    state.matrixDrops.push({
      x: i * 20,
      y: Math.random() * state.h,
      speed: Math.random() * 3 + 2,
      chars: generateMatrixChars(),
      charIndex: 0
    });
  }
}

function initFireflies() {
  state.fireflies = [];
  const count = state.w < 768 ? 25 : 50;
  for (let i = 0; i < count; i++) {
    state.fireflies.push({
      x: Math.random() * state.w,
      y: Math.random() * state.h,
      vx: (Math.random() - 0.5) * 0.5,
      vy: (Math.random() - 0.5) * 0.5,
      radius: Math.random() * 2 + 1,
      alpha: Math.random(),
      pulse: Math.random() * Math.PI * 2
    });
  }
}

function generateMatrixChars() {
  const chars = 'ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³0123456789ABCDEF';
  return Array(20).fill(0).map(() => chars[Math.floor(Math.random() * chars.length)]);
}

/* ==================== Drawing Functions ==================== */
function drawBackground() {
  const { ctx, w, h } = state;
  
  // Clear
  ctx.fillStyle = getThemeColor('--bg-color');
  ctx.fillRect(0, 0, w, h);
  
  switch(state.bgMode) {
    case 'cyberweb': drawCyberWeb(); break;
    case 'particles': drawParticles3D(); break;
    case 'matrix': drawMatrixRain(); break;
    case 'aurora': drawAurora(); break;
    case 'fireflies': drawFireflies(); break;
    case 'gradient': drawAnimatedGradient(); break;
    case 'image': drawUploadedImage(); break;
    default: break;
  }
}

function drawCyberWeb() {
  const { ctx, w, h, mouse } = state;
  const color = getThemeColor('--primary-color');
  const rgb = hexToRgb(color);
  
  state.particles.forEach((p, i) => {
    p.x += p.vx;
    p.y += p.vy;
    p.pulse += 0.05;
    
    if (p.x < 0 || p.x > w) p.vx *= -1;
    if (p.y < 0 || p.y > h) p.vy *= -1;
    
    // Mouse interaction
    if (mouse.active) {
      const dx = mouse.x - p.x;
      const dy = mouse.y - p.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < 150) {
        p.x -= dx * 0.02;
        p.y -= dy * 0.02;
      }
    }
    
    // Draw connections
    state.particles.slice(i + 1).forEach(p2 => {
      const dx = p.x - p2.x;
      const dy = p.y - p2.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < 120) {
        const alpha = (1 - dist / 120) * 0.3 * p.life;
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
        ctx.lineTo(p2.x, p2.y);
        ctx.strokeStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
        ctx.lineWidth = 0.5;
        ctx.stroke();
      }
    });
    
    // Draw particle
    const alpha = (0.3 + 0.3 * Math.sin(p.pulse)) * p.life;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.z, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
    ctx.shadowColor = color;
    ctx.shadowBlur = state.effects.glow / 2;
    ctx.fill();
    ctx.shadowBlur = 0;
  });
}

function drawParticles3D() {
  const { ctx, w, h, mouse } = state;
  const color = getThemeColor('--primary-color');
  const rgb = hexToRgb(color);
  const time = now() * 0.001;
  
  state.particles.forEach(p => {
    const z = p.z + Math.sin(time + p.x * 0.01) * 0.5;
    const scale = z / 3;
    const x = p.x + Math.sin(time + p.y * 0.01) * 20;
    const y = p.y + Math.cos(time + p.x * 0.01) * 20;
    
    ctx.beginPath();
    ctx.arc(x, y, 2 * scale, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${0.5 * scale})`;
    ctx.shadowColor = color;
    ctx.shadowBlur = state.effects.glow * scale;
    ctx.fill();
  });
}

function drawMatrixRain() {
  const { ctx, w, h } = state;
  const color = getThemeColor('--primary-color');
  
  ctx.font = '14px "Share Tech Mono"';
  ctx.fillStyle = color;
  
  state.matrixDrops.forEach(drop => {
    drop.y += drop.speed;
    if (drop.y > h) {
      drop.y = -20;
      drop.chars = generateMatrixChars();
    }
    
    drop.chars.forEach((char, i) => {
      const y = drop.y - i * 16;
      if (y > 0 && y < h) {
        const alpha = 1 - (i / drop.chars.length);
        ctx.fillStyle = i === 0 ? '#fff' : `rgba(0, 255, 204, ${alpha})`;
        ctx.fillText(char, drop.x, y);
      }
    });
  });
}

function drawAurora() {
  const { ctx, w, h } = state;
  const time = now() * 0.0005;
  const color = getThemeColor('--primary-color');
  const rgb = hexToRgb(color);
  
  for (let i = 0; i < 5; i++) {
    const gradient = ctx.createLinearGradient(0, 0, w, 0);
    const offset = i * 0.2;
    const alpha = 0.1 - i * 0.015;
    
    gradient.addColorStop(0, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0)`);
    gradient.addColorStop(0.3 + Math.sin(time + offset) * 0.2, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`);
    gradient.addColorStop(0.7 + Math.cos(time + offset) * 0.2, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`);
    gradient.addColorStop(1, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0)`);
    
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.moveTo(0, h * (0.3 + i * 0.1));
    
    for (let x = 0; x <= w; x += 50) {
      const y = h * (0.3 + i * 0.1) + Math.sin(x * 0.01 + time + i) * 50;
      ctx.lineTo(x, y);
    }
    
    ctx.lineTo(w, h);
    ctx.lineTo(0, h);
    ctx.fill();
  }
}

function drawFireflies() {
  const { ctx, w, h } = state;
  const color = getThemeColor('--primary-color');
  const rgb = hexToRgb(color);
  const time = now() * 0.001;
  
  state.fireflies.forEach(f => {
    f.x += f.vx + Math.sin(time + f.pulse) * 0.5;
    f.y += f.vy + Math.cos(time + f.pulse) * 0.5;
    f.pulse += 0.02;
    
    if (f.x < 0) f.x = w;
    if (f.x > w) f.x = 0;
    if (f.y < 0) f.y = h;
    if (f.y > h) f.y = 0;
    
    const alpha = (0.5 + 0.5 * Math.sin(f.pulse)) * f.alpha;
    ctx.beginPath();
    ctx.arc(f.x, f.y, f.radius, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
    ctx.shadowColor = color;
    ctx.shadowBlur = state.effects.glow;
    ctx.fill();
  });
}

function drawAnimatedGradient() {
  const { ctx, w, h } = state;
  const time = now() * 0.0003;
  const color = getThemeColor('--primary-color');
  const secondary = getThemeColor('--secondary-color');
  
  const gradient = ctx.createRadialGradient(
    w * (0.5 + Math.sin(time) * 0.3),
    h * (0.5 + Math.cos(time) * 0.3),
    0,
    w / 2, h / 2, Math.max(w, h)
  );
  
  gradient.addColorStop(0, color + '20');
  gradient.addColorStop(0.5, secondary + '10');
  gradient.addColorStop(1, 'transparent');
  
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, w, h);
}

function drawUploadedImage() {
  if (!state.uploadedImage || !state.imageLoaded) return;
  
  const { ctx, w, h } = state;
  const img = state.uploadedImage;
  const f = state.filters;
  
  const scale = Math.max(w / img.width, h / img.height);
  const dw = img.width * scale;
  const dh = img.height * scale;
  const dx = (w - dw) / 2;
  const dy = (h - dh) / 2;
  
  ctx.save();
  ctx.filter = `brightness(${f.brightness}%) contrast(${f.contrast}%) saturate(${f.saturation}%) blur(${f.blur}px) hue-rotate(${f.hue}deg)`;
  ctx.globalAlpha = f.opacity / 100;
  ctx.drawImage(img, dx, dy, dw, dh);
  ctx.restore();
}

/* ==================== Text Rendering ==================== */
function drawText() {
  if (!state.displayedText.length) return;
  
  const { ctx, w, h } = state;
  const color = getThemeColor('--primary-color');
  const rgb = hexToRgb(color);
  const style = state.textStyle;
  
  // Calculate font size
  let fontSize = Math.min(w * 0.12, (h * 0.6) / state.displayedText.length);
  fontSize = fontSize * (style.size / 80);
  
  ctx.font = `900 ${fontSize}px ${FONTS[state.font]}`;
  ctx.letterSpacing = style.letterSpacing + 'px';
  
  // Check width
  let maxWidth = 0;
  state.displayedText.forEach(line => {
    maxWidth = Math.max(maxWidth, ctx.measureText(line).width);
  });
  if (maxWidth > w * 0.9) {
    fontSize *= (w * 0.9 / maxWidth);
    ctx.font = `900 ${fontSize}px ${FONTS[state.font]}`;
  }
  
  const lineHeight = fontSize * 1.3;
  const totalHeight = state.displayedText.length * lineHeight;
  const startY = (h - totalHeight) / 2 + lineHeight / 2;
  
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  
  state.displayedText.forEach((line, i) => {
    const y = startY + i * lineHeight;
    const x = w / 2;
    
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(style.rotation * Math.PI / 180);
    
    // Glitch effect
    if (state.effects.glitch && state.glitchIntensity > 0.1) {
      const offsetX = (Math.random() - 0.5) * state.glitchIntensity * 10;
      const offsetY = (Math.random() - 0.5) * state.glitchIntensity * 5;
      
      // RGB split
      ctx.globalCompositeOperation = 'screen';
      ctx.fillStyle = `rgba(255, 0, 0, ${0.6 * state.glitchIntensity})`;
      ctx.fillText(line, offsetX - 2, offsetY);
      ctx.fillStyle = `rgba(0, 255, 255, ${0.6 * state.glitchIntensity})`;
      ctx.fillText(line, offsetX + 2, offsetY);
      ctx.globalCompositeOperation = 'source-over';
    }
    
    // Shadow
    if (style.shadow) {
      ctx.shadowColor = color;
      ctx.shadowBlur = state.effects.glow;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
    }
    
    // Lighting effect
    if (style.lighting) {
      const gradient = ctx.createLinearGradient(-fontSize, -fontSize, fontSize, fontSize);
      gradient.addColorStop(0, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1)`);
      gradient.addColorStop(0.5, '#ffffff');
      gradient.addColorStop(1, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1)`);
      ctx.fillStyle = gradient;
    } else {
      ctx.fillStyle = color;
    }
    
    ctx.fillText(line, 0, 0);
    ctx.restore();
  });
  
  ctx.letterSpacing = '0px';
}

/* ==================== Main Render Loop ==================== */
function renderLoop(timestamp) {
  const dt = timestamp - state.lastFrameTime;
  state.lastFrameTime = timestamp;
  
  // FPS calculation
  state.fps = Math.round(1000 / dt) || 60;
  if (elements['fps-counter']) {
    elements['fps-counter'].textContent = `${state.fps} FPS`;
  }
  
  // Update glitch
  state.glitchIntensity = Math.max(0, state.glitchIntensity * 0.95 - 0.01);
  
  // Draw
  drawBackground();
  drawText();
  
  state.animationId = requestAnimationFrame(renderLoop);
}

/* ==================== Image Handling ==================== */
async function handleImageUpload(file) {
  if (!file || !file.type.startsWith('image/')) {
    showToast('âŒ Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø©');
    return;
  }
  
  if (file.size > 50 * 1024 * 1024) {
    showToast('âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯: 50MB)');
    return;
  }
  
  showToast('ğŸ“¸ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...');
  
  try {
    const reader = new FileReader();
    reader.onload = async (e) => {
      const imageData = e.target.result;
      
      // Save to IndexedDB
      await saveImageToDB(imageData, {
        name: file.name,
        size: file.size,
        type: file.type
      });
      
      // Load image
      const img = new Image();
      img.onload = () => {
        state.uploadedImage = img;
        state.imageLoaded = true;
        state.bgMode = 'image';
        elements['bg-select'].value = 'image';
        savePreference('bgMode', 'image');
        showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!');
        updateImageStatus();
      };
      img.src = imageData;
    };
    reader.readAsDataURL(file);
  } catch (err) {
    console.error('Image upload error:', err);
    showToast('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©');
  }
}

async function loadSavedImage() {
  try {
    const saved = await loadImageFromDB();
    if (saved && saved.data) {
      const img = new Image();
      img.onload = () => {
        state.uploadedImage = img;
        state.imageLoaded = true;
        updateImageStatus();
      };
      img.src = saved.data;
    }
  } catch (err) {
    console.error('Failed to load saved image:', err);
  }
}

async function clearImage() {
  state.uploadedImage = null;
  state.imageLoaded = false;
  await clearImageFromDB();
  if (state.bgMode === 'image') {
    state.bgMode = 'cyberweb';
    elements['bg-select'].value = 'cyberweb';
  }
  showToast('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø©');
  updateImageStatus();
}

function updateImageStatus() {
  const status = elements['image-status'];
  if (status) {
    status.textContent = state.imageLoaded ? 'âœ… ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø©' : 'âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©';
  }
}

/* ==================== Export & Share ==================== */
function exportToPNG() {
  const exportCanvas = document.createElement('canvas');
  exportCanvas.width = state.canvas.width;
  exportCanvas.height = state.canvas.height;
  const ctx = exportCanvas.getContext('2d');
  
  // Draw current frame
  ctx.drawImage(state.canvas, 0, 0);
  
  // Add effects overlay
  if (state.effects.scanlines > 0) {
    ctx.fillStyle = `rgba(0,0,0,${state.effects.scanlines/200})`;
    for (let y = 0; y < exportCanvas.height; y += 3) {
      ctx.fillRect(0, y, exportCanvas.width, 1);
    }
  }
  
  const link = document.createElement('a');
  link.download = `cyber-nexus-${Date.now()}.png`;
  link.href = exportCanvas.toDataURL('image/png', 1.0);
  link.click();
  
  showToast('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©!');
  if (navigator.vibrate) navigator.vibrate([50, 100, 50]);
}

async function shareContent() {
  const text = state.displayedText.join('\n') || 'Cyber-Nexus V3.0 Ultra';
  
  if (navigator.share) {
    try {
      await navigator.share({
        title: 'Cyber-Nexus',
        text: text.substring(0, 100) + '...',
        url: window.location.href
      });
      showToast('ğŸ“¤ ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©!');
    } catch (err) {
      // User cancelled
    }
  } else {
    // Fallback to clipboard
    navigator.clipboard.writeText(window.location.href).then(() => {
      showToast('ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!');
    });
  }
}

/* ==================== Theme & Style ==================== */
function applyTheme(themeName) {
  const theme = THEMES[themeName];
  if (!theme) return;
  
  const root = document.documentElement;
  root.style.setProperty('--primary-color', theme.primary);
  root.style.setProperty('--secondary-color', theme.secondary);
  root.style.setProperty('--panel-border', theme.border);
  
  state.theme = themeName;
  savePreference('theme', themeName);
}

function applyFont(fontName) {
  if (!FONTS[fontName]) return;
  document.documentElement.style.setProperty('--font-main', FONTS[fontName]);
  state.font = fontName;
  savePreference('font', fontName);
}

function updateEffectsCSS() {
  const root = document.documentElement;
  root.style.setProperty('--scanline-opacity', state.effects.scanlines / 100);
  root.style.setProperty('--vignette-opacity', state.effects.vignette / 100);
  root.style.setProperty('--grain-opacity', state.effects.grain / 100);
  root.style.setProperty('--glow-intensity', state.effects.glow);
}

/* ==================== Event Listeners ==================== */
function setupEventListeners() {
  // UI Toggle
  elements['secret-trigger'].addEventListener('click', toggleAdmin);
  elements['ui-close-btn'].addEventListener('click', toggleAdmin);
  elements['ui-overlay'].addEventListener('click', toggleAdmin);
  
  // Buttons
  elements['btn-update'].addEventListener('click', () => fetchData(true));
  elements['btn-export-png'].addEventListener('click', exportToPNG);
  elements['fab-export'].addEventListener('click', exportToPNG);
  elements['btn-share'].addEventListener('click', shareContent);
  elements['fab-share'].addEventListener('click', shareContent);
  elements['btn-fullscreen'].addEventListener('click', toggleFullscreen);
  elements['fab-fullscreen'].addEventListener('click', toggleFullscreen);
  elements['btn-clear-image'].addEventListener('click', clearImage);
  elements['btn-clear-all'].addEventListener('click', clearAll);
  elements['btn-retry-fetch'].addEventListener('click', () => {
    elements['error-overlay'].classList.remove('show');
    fetchData(true);
  });
  
  // Selects
  elements['bg-select'].addEventListener('change', (e) => {
    state.bgMode = e.target.value;
    savePreference('bgMode', state.bgMode);
    if (state.bgMode === 'matrix') initMatrixDrops();
    if (state.bgMode === 'fireflies') initFireflies();
  });
  
  elements['theme-select'].addEventListener('change', (e) => applyTheme(e.target.value));
  elements['font-select'].addEventListener('change', (e) => applyFont(e.target.value));
  
  // File upload
  elements['img-uploader'].addEventListener('change', (e) => {
    if (e.target.files[0]) handleImageUpload(e.target.files[0]);
  });
  
  // Text input
  elements['msg-input'].addEventListener('input', (e) => {
    state.displayedText = e.target.value.split('\n').filter(l => l.trim());
    savePreference('text', e.target.value);
  });
  
  // Effect sliders
  setupSlider('scanline-slider', 'scanlines', updateEffectsCSS);
  setupSlider('vignette-slider', 'vignette', updateEffectsCSS);
  setupSlider('grain-slider', 'grain', updateEffectsCSS);
  setupSlider('glow-slider', 'glow', updateEffectsCSS);
  
  // Toggles
  setupToggle('glitch-toggle', 'glitch');
  setupToggle('animation-toggle', 'animation');
  setupToggle('shadow-toggle', 'shadow', null, state.textStyle);
  setupToggle('lighting-toggle', 'lighting', null, state.textStyle);
  
  // Filter sliders
  setupSlider('brightness-slider', 'brightness', null, state.filters);
  setupSlider('contrast-slider', 'contrast', null, state.filters);
  setupSlider('saturation-slider', 'saturation', null, state.filters);
  setupSlider('blur-slider', 'blur', null, state.filters);
  setupSlider('opacity-slider', 'opacity', null, state.filters);
  setupSlider('hue-slider', 'hue', null, state.filters);
  
  // Text style sliders
  setupSlider('font-size-slider', 'size', null, state.textStyle);
  setupSlider('letter-spacing-slider', 'letterSpacing', null, state.textStyle);
  setupSlider('rotation-slider', 'rotation', null, state.textStyle);
  
  elements['btn-reset-filters'].addEventListener('click', () => {
    state.filters = { brightness: 100, contrast: 120, saturation: 100, blur: 0, opacity: 100, hue: 0 };
    ['brightness', 'contrast', 'saturation', 'blur', 'opacity', 'hue'].forEach(key => {
      elements[key + '-slider'].value = state.filters[key];
    });
    showToast('ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±');
  });
  
  // Drag & drop
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
    document.body.addEventListener(event, preventDefaults);
  });
  
  document.body.addEventListener('dragenter', () => elements['drop-zone'].classList.add('active'));
  document.body.addEventListener('dragleave', (e) => {
    if (e.relatedTarget === null) elements['drop-zone'].classList.remove('active');
  });
  document.body.addEventListener('drop', (e) => {
    elements['drop-zone'].classList.remove('active');
    const files = e.dataTransfer.files;
    if (files.length) handleImageUpload(files[0]);
  });
  
  // Window events
  window.addEventListener('resize', debounce(resizeCanvas, 100));
  
  // Mouse tracking
  state.canvas.addEventListener('mousemove', (e) => {
    state.mouse.x = e.clientX;
    state.mouse.y = e.clientY;
    state.mouse.active = true;
  });
  state.canvas.addEventListener('mouseleave', () => state.mouse.active = false);
  
  // Touch
  state.canvas.addEventListener('touchmove', (e) => {
    if (e.touches[0]) {
      state.mouse.x = e.touches[0].clientX;
      state.mouse.y = e.touches[0].clientY;
      state.mouse.active = true;
    }
  }, { passive: true });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && state.isAdmin) toggleAdmin();
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      exportToPNG();
    }
  });
  
  // Double tap to toggle
  let lastTap = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTap < 300) toggleAdmin();
    lastTap = now;
  });
  
  // Collapsible sections
  document.querySelectorAll('.collapsible-header').forEach(header => {
    header.addEventListener('click', () => {
      header.parentElement.classList.toggle('open');
    });
  });
}

function setupSlider(id, key, callback, target = state.effects) {
  elements[id].addEventListener('input', (e) => {
    target[key] = parseInt(e.target.value);
    if (callback) callback();
  });
}

function setupToggle(id, key, callback, target = state.effects) {
  elements[id].addEventListener('click', (e) => {
    target[key] = !target[key];
    e.target.classList.toggle('active', target[key]);
    if (callback) callback();
  });
}

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

function debounce(fn, ms) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), ms);
  };
}

/* ==================== Admin Toggle ==================== */
function toggleAdmin() {
  state.isAdmin = !state.isAdmin;
  document.body.classList.toggle('admin-mode', state.isAdmin);
  elements['ui-layer'].setAttribute('aria-hidden', !state.isAdmin);
  if (navigator.vibrate && state.isAdmin) navigator.vibrate(30);
}

/* ==================== Fullscreen ==================== */
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(() => {});
  } else {
    document.exitFullscreen();
  }
}

/* ==================== Data Fetching ==================== */
async function fetchData(manual = false) {
  elements['loading-indicator'].style.display = 'flex';
  state.glitchIntensity = 1;
  
  try {
    const response = await fetch(`${CONSTANTS.RAW_URL}?t=${Date.now()}`, {
      cache: 'no-store',
      signal: AbortSignal.timeout(CONSTANTS.FETCH_TIMEOUT)
    });
    
    if (!response.ok) throw new Error('Network error');
    
    const text = await response.text();
    processData(text);
    
    elements['error-overlay'].classList.remove('show');
    showToast(manual ? 'âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«!' : 'âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
  } catch (err) {
    console.error('Fetch error:', err);
    elements['error-message'].textContent = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
    elements['error-overlay'].classList.add('show');
  } finally {
    elements['loading-indicator'].style.display = 'none';
  }
}

function processData(text) {
  state.lines = text.split('\n').filter(l => l.trim());
  state.displayedText = [...state.lines];
  elements['msg-input'].value = text;
  savePreference('text', text);
}

/* ==================== Storage ==================== */
function savePreference(key, value) {
  try {
    localStorage.setItem(`cn_${key}`, JSON.stringify(value));
  } catch (e) {}
}

function loadPreference(key, defaultValue) {
  try {
    const item = localStorage.getItem(`cn_${key}`);
    return item ? JSON.parse(item) : defaultValue;
  } catch (e) {
    return defaultValue;
  }
}

function restorePreferences() {
  // Restore theme
  const savedTheme = loadPreference('theme', 'cyan');
  applyTheme(savedTheme);
  elements['theme-select'].value = savedTheme;
  
  // Restore font
  const savedFont = loadPreference('font', 'electrolize');
  applyFont(savedFont);
  elements['font-select'].value = savedFont;
  
  // Restore bg mode
  const savedBg = loadPreference('bgMode', 'cyberweb');
  state.bgMode = savedBg;
  elements['bg-select'].value = savedBg;
  
  // Restore text
  const savedText = loadPreference('text', '');
  if (savedText) {
    elements['msg-input'].value = savedText;
    state.displayedText = savedText.split('\n').filter(l => l.trim());
  }
}

async function clearAll() {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) return;
  
  // Clear state
  state.uploadedImage = null;
  state.imageLoaded = false;
  state.displayedText = [];
  
  // Clear storage
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith('cn_')) localStorage.removeItem(key);
  });
  
  await clearImageFromDB();
  
  // Reset UI
  elements['msg-input'].value = '';
  applyTheme('cyan');
  applyFont('electrolize');
  state.bgMode = 'cyberweb';
  elements['bg-select'].value = 'cyberweb';
  
  showToast('â™»ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
  updateImageStatus();
}

/* ==================== Helpers ==================== */
function getThemeColor(varName) {
  return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
}

function hexToRgb(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : { r: 0, g: 255, b: 204 };
}

/* ==================== Start ==================== */
window.addEventListener('load', init);

// Expose API
window.CYBERNEXUS = {
  fetchData,
  exportToPNG,
  shareContent,
  toggleFullscreen,
  toggleAdmin,
  setTheme: applyTheme,
  setFont: applyFont,
  clearImage,
  clearAll,
  getState: () => ({ ...state })
};
</script>
</body>
</html>